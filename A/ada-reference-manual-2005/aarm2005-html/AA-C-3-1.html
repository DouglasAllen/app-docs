<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
    <TITLE>Protected Procedure Handlers</TITLE>
    <META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <META NAME="Author" CONTENT="JTC1/SC22/WG9/ARG, by Randall Brukardt, ARG Editor">
    <META NAME="GENERATOR" CONTENT="Arm_Form.Exe, Ada Reference Manual generator">
    <STYLE type="text/css">
    H4.centered {text-align: center}
    SPAN.swiss {font-family: Arial, Helvetica, sans-serif; font-size: 92%}
    SPAN.roman {font-family: "Times New Roman", Times, serif}
    DIV.paranum {float: left; font-family: Arial, Helvetica, sans-serif; font-size: 64%; width: 2.8em; margin-left: -0.4em; margin-right: -3.0em; margin-top: 0.2em}
    TT {font-family: "Courier New", monospace}
    DT {display: compact}
    DIV.Normal {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 1.2em; margin-bottom: 0.6em}
    DIV.Indented1 {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.2em; margin-bottom: 0.6em}
    DIV.Notes {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 3.7em; margin-bottom: 0.6em}
    DIV.Annotations {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 6.2em; margin-bottom: 0.6em}
    DIV.NotesHeader {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 3.7em}
    DIV.Bulleted-NoPrefix {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.2em; margin-right: 2.0em; margin-top: 0em; margin-bottom: 0.5em}
    DIV.Bulleted {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.2em; margin-right: 2.0em; margin-top: 0em; margin-bottom: 0.5em; display: list-item; list-style-type: disc}
    </STYLE>
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFF0" LINK="#000080" VLINK="#330033" ALINK="#0000FF">
<DIV><B><SPAN Style="font-size:200%; color: rgb(0,51,153)">Annotated</SPAN><SPAN Style="font-size:200%; color: rgb(0,0,102)">&nbsp;Ada Reference Manual</SPAN></B> &mdash; <A HREF="AA-TTL.html"><B>Legal Information</B></A></DIV>
<div style="margin-top: 0.6em; margin-bottom: 0.0em"><A HREF="AA-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-0-5.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-C-3.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-C-3-2.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</div>
<HR>
<H1>C.3.1 Protected Procedure Handlers</H1>

<H4 Class="centered">Syntax</H4>
<div class="paranum">1</div>
<div class="Indented1" style="margin-bottom: 0.4em">The form of a <SPAN Class="swiss"><A HREF="AA-2-8.html#S0019">pragma</A></SPAN> 
Interrupt_Handler is as follows:&nbsp;</div>
<div class="paranum">2</div>
<div class="Indented1">&nbsp;&nbsp;<B>pragma</B> <A NAME="I7120"></A><A NAME="I7121"></A>Interrupt_Handler(<I>handler_</I><A NAME="I7122"></A><SPAN Class="swiss"><A HREF="AA-4-1.html#S0091">name</A></SPAN>);</div>
<div class="paranum">3</div>
<div class="Indented1" style="margin-bottom: 0.4em">The form of a <SPAN Class="swiss"><A HREF="AA-2-8.html#S0019">pragma</A></SPAN> 
Attach_Handler is as follows:&nbsp;</div>
<div class="paranum">4</div>
<div class="Indented1">&nbsp;&nbsp;<B>pragma</B> <A NAME="I7123"></A><A NAME="I7124"></A>Attach_Handler(<I>handler_</I><A NAME="I7125"></A><SPAN Class="swiss"><A HREF="AA-4-1.html#S0091">name</A></SPAN>, 
<A NAME="I7126"></A><SPAN Class="swiss"><A HREF="AA-4-4.html#S0115">expression</A></SPAN>); 
</div>

<H4 Class="centered">Name Resolution Rules</H4>
<div class="paranum">5</div>
<div class="Normal">For the Interrupt_Handler and Attach_Handler pragmas, 
the <I>handler_</I><SPAN Class="swiss"><A HREF="AA-4-1.html#S0091">name</A></SPAN> 
shall resolve to denote a protected procedure with a parameterless profile.</div>
<div class="paranum">6</div>
<div class="Normal">For the Attach_Handler pragma, the expected type 
for the <SPAN Class="swiss"><A HREF="AA-4-4.html#S0115">expression</A></SPAN> 
is Interrupts.Interrupt_ID (see <A HREF="AA-C-3-2.html">C.3.2</A>).&nbsp;</div>

<H4 Class="centered">Legality Rules</H4>
<div class="paranum">7/2</div>
<div class="Normal">{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00434.TXT">AI95-00434-01</A></I>} 
The Attach_Handler pragma is only allowed immediately within the <SPAN Class="swiss"><A HREF="AA-9-4.html#S0195">protected_definition</A></SPAN> 
where the corresponding subprogram is declared. The corresponding <SPAN Class="swiss"><A HREF="AA-9-4.html#S0193">protected_type_declaration</A></SPAN> 
or <SPAN Class="swiss"><A HREF="AA-9-4.html#S0194">single_protected_declaration</A></SPAN> 
shall be a library-level declaration.&nbsp;</div>
<div class="paranum">7.a</div>
<div class="Annotations"><B>Discussion:&nbsp;</B>In the case of a <SPAN Class="swiss"><A HREF="AA-9-4.html#S0193">protected_type_declaration</A></SPAN>, 
an <SPAN Class="swiss"><A HREF="AA-3-3-1.html#S0032">object_declaration</A></SPAN> 
of an object of that type need not be at library level.&nbsp;</div>
<div class="paranum">8/2</div>
<div class="Normal">{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00253.TXT">AI95-00253-01</A></I>} 
{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00303.TXT">AI95-00303-01</A></I>} 
The Interrupt_Handler pragma is only allowed immediately within the <SPAN Class="swiss"><A HREF="AA-9-4.html#S0195">protected_definition</A></SPAN> 
where the corresponding subprogram is declared. The corresponding <SPAN Class="swiss"><A HREF="AA-9-4.html#S0193">protected_type_declaration</A></SPAN> 
or <SPAN Class="swiss"><A HREF="AA-9-4.html#S0194">single_protected_declaration</A></SPAN> 
shall be a library-level declaration.&nbsp;</div>

<H4 Class="centered">Dynamic Semantics</H4>
<div class="paranum">9</div>
<div class="Normal">If the pragma Interrupt_Handler appears in a <SPAN Class="swiss"><A HREF="AA-9-4.html#S0195">protected_definition</A></SPAN>, 
then the corresponding procedure can be attached dynamically, as a handler, 
to interrupts (see <A HREF="AA-C-3-2.html">C.3.2</A>). [Such procedures 
are allowed to be attached to multiple interrupts.]</div>
<div class="paranum">10</div>
<div class="Normal"><SPAN STYLE="font-size: 80%">{<I>creation (of a protected 
object)</I>}</SPAN> <A NAME="I7127"></A><SPAN STYLE="font-size: 80%">{<I>initialization 
(of a protected object)</I>}</SPAN> <A NAME="I7128"></A>The <SPAN Class="swiss"><A HREF="AA-4-4.html#S0115">expression</A></SPAN> 
in the Attach_Handler pragma [as evaluated at object creation time] specifies 
an interrupt. As part of the initialization of that object, if the Attach_Handler 
pragma is specified, the <I>handler</I> procedure is attached to the 
specified interrupt. <SPAN STYLE="font-size: 80%">{<I>Reserved_Check</I> 
[partial]}</SPAN> <A NAME="I7129"></A><SPAN STYLE="font-size: 80%">{<I>check, 
language-defined (Reserved_Check)</I>}</SPAN> <A NAME="I7130"></A>A check 
is made that the corresponding interrupt is not reserved. <SPAN STYLE="font-size: 80%">{<I>Program_Error 
(raised by failure of run-time check)</I>}</SPAN> <A NAME="I7131"></A>Program_Error 
is raised if the check fails, and the existing treatment for the interrupt 
is not affected.</div>
<div class="paranum">11/2</div>
<div class="Normal">&nbsp;{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00434.TXT">AI95-00434-01</A></I>} 
<SPAN STYLE="font-size: 80%">{<I>initialization (of a protected object)</I>}</SPAN> 
<A NAME="I7132"></A><SPAN STYLE="font-size: 80%">{<I>Ceiling_Check</I> 
[partial]}</SPAN> <A NAME="I7133"></A><SPAN STYLE="font-size: 80%">{<I>check, 
language-defined (Ceiling_Check)</I>}</SPAN> <A NAME="I7134"></A>If the 
Ceiling_Locking policy (see <A HREF="AA-D-3.html">D.3</A>) is in effect, 
then upon the initialization of a protected object for which either an 
Attach_Handler or Interrupt_Handler pragma applies to one of its procedures, 
a check is made that the ceiling priority defined in the <SPAN Class="swiss"><A HREF="AA-9-4.html#S0195">protected_definition</A></SPAN> 
is in the range of System.Interrupt_Priority. <SPAN STYLE="font-size: 80%">{<I>Program_Error 
(raised by failure of run-time check)</I>}</SPAN> <A NAME="I7135"></A>If 
the check fails, Program_Error is raised.</div>
<div class="paranum">12/1</div>
<div class="Normal">&nbsp;{<I><A HREF="defect1.html#8652/0068">8652/0068</A></I>} 
{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00121.TXT">AI95-00121-01</A></I>} 
<SPAN STYLE="font-size: 80%">{<I>finalization (of a protected object)</I>}</SPAN> 
<A NAME="I7136"></A>When a protected object is finalized, for any of 
its procedures that are attached to interrupts, the handler is detached. 
If the handler was attached by a procedure in the Interrupts package 
or if no user handler was previously attached to the interrupt, the default 
treatment is restored. If an Attach_Handler pragma was used and the most 
recently attached handler for the same interrupt is the same as the one 
that was attached at the time the protected object was initialized, the 
previous handler is restored.&nbsp;</div>
<div class="paranum">12.a/2</div>
<div class="Annotations"><B>Discussion:&nbsp;</B>{<I><A HREF="defect1.html#8652/0068">8652/0068</A></I>} 
{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00121.TXT">AI95-00121-01</A></I>} 
{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00303.TXT">AI95-00303-01</A></I>} 
If all protected objects for interrupt handlers are declared at the library 
level, the finalization discussed above occurs only as part of the finalization 
of all library-level packages in a partition. However, objects of a protected 
type containing an Attach_Handler pragma need not be at the library level. 
Thus, an implementation needs to be able to restore handlers during the 
execution of the program. (An object with an Interrupt_Handler pragma 
also need not be at the library level, but such a handler cannot be attached 
to an interrupt using the Interrupts package.)&nbsp;</div>
<div class="paranum">13</div>
<div class="Normal">When a handler is attached to an interrupt, the interrupt 
is blocked [(subject to the Implementation Permission in <A HREF="AA-C-3.html">C.3</A>)] 
during the execution of every protected action on the protected object 
containing the handler.</div>

<H4 Class="centered">Erroneous Execution</H4>
<div class="paranum">14</div>
<div class="Normal"><SPAN STYLE="font-size: 80%">{<I>erroneous execution 
(cause)</I> [partial]}</SPAN> <A NAME="I7137"></A>If the Ceiling_Locking 
policy (see <A HREF="AA-D-3.html">D.3</A>) is in effect and an interrupt 
is delivered to a handler, and the interrupt hardware priority is higher 
than the ceiling priority of the corresponding protected object, the 
execution of the program is erroneous.</div>
<div class="paranum">14.1/1</div>
<div class="Normal">&nbsp;&nbsp;&nbsp;{<I><A HREF="defect1.html#8652/0068">8652/0068</A></I>} 
{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00121.TXT">AI95-00121-01</A></I>} 
<SPAN STYLE="font-size: 80%">{<I>erroneous execution (cause)</I> [partial]}</SPAN> 
<A NAME="I7138"></A>If the handlers for a given interrupt attached via 
pragma Attach_Handler are not attached and detached in a stack-like (LIFO) 
order, program execution is erroneous. In particular, when a protected 
object is finalized, the execution is erroneous if any of the procedures 
of the protected object are attached to interrupts via pragma Attach_Handler 
and the most recently attached handler for the same interrupt is not 
the same as the one that was attached at the time the protected object 
was initialized.&nbsp;</div>
<div class="paranum">14.a.1/1</div>
<div class="Annotations"><B>Discussion:&nbsp;</B>{<I><A HREF="defect1.html#8652/0068">8652/0068</A></I>} 
{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00121.TXT">AI95-00121-01</A></I>} 
This simplifies implementation of the Attach_Handler pragma by not requiring 
a check that the current handler is the same as the one attached by the 
initialization of a protected object.&nbsp;</div>

<H4 Class="centered">Metrics</H4>
<div class="paranum">15</div>
<div class="Normal" style="margin-bottom: 0.4em">The following metric 
shall be documented by the implementation:&nbsp;</div>
<div class="paranum">16/2</div>
<div class="Bulleted">{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00434.TXT">AI95-00434-01</A></I>} 
The worst-case overhead for an interrupt handler that is a parameterless 
protected procedure, in clock cycles. This is the execution time not 
directly attributable to the handler procedure or the interrupted execution. 
It is estimated as C &ndash; (A+B), where A is how long it takes to complete 
a given sequence of instructions without any interrupt, B is how long 
it takes to complete a normal call to a given protected procedure, and 
C is how long it takes to complete the same sequence of instructions 
when it is interrupted by one execution of the same procedure called 
via an interrupt.&nbsp;</div>
<div class="paranum">16.a</div>
<div class="Annotations"><B>Implementation Note:&nbsp;</B>The instruction 
sequence and interrupt handler used to measure interrupt handling overhead 
should be chosen so as to maximize the execution time cost due to cache 
misses. For example, if the processor has cache memory and the activity 
of an interrupt handler could invalidate the contents of cache memory, 
the handler should be written such that it invalidates all of the cache 
memory.&nbsp;</div>
<div class="paranum">16.b/2</div>
<div class="Annotations"><B>Documentation Requirement:&nbsp;</B>The metrics 
for interrupt handlers.</div>

<H4 Class="centered">Implementation Permissions</H4>
<div class="paranum">17</div>
<div class="Normal">When the pragmas Attach_Handler or Interrupt_Handler 
apply to a protected procedure, the implementation is allowed to impose 
implementation-defined restrictions on the corresponding <SPAN Class="swiss"><A HREF="AA-9-4.html#S0193">protected_type_declaration</A></SPAN> 
and <SPAN Class="swiss"><A HREF="AA-9-4.html#S0198">protected_body</A></SPAN>. 
</div>
<div class="paranum">17.a</div>
<div class="Annotations"><B>Ramification:&nbsp;</B>The restrictions may be 
on the constructs that are allowed within them, and on ordinary calls 
(i.e. not via interrupts) on protected operations in these protected 
objects.&nbsp;</div>
<div class="paranum">17.b/2</div>
<div class="Annotations"><B>Implementation defined:&nbsp;</B>Any restrictions 
on a protected procedure or its containing type when a <SPAN Class="swiss"><A HREF="AA-2-8.html#S0019">pragma</A></SPAN> 
Attach_handler or Interrupt_Handler applies.</div>
<div class="paranum">18</div>
<div class="Normal">An implementation may use a different mechanism for 
invoking a protected procedure in response to a hardware interrupt than 
is used for a call to that protected procedure from a task.&nbsp;</div>
<div class="paranum">18.a</div>
<div class="Annotations"><B>Discussion:&nbsp;</B>This is despite the fact 
that the priority of an interrupt handler (see <A HREF="AA-D-1.html">D.1</A>) 
is modeled after a hardware task calling the handler.&nbsp;</div>
<div class="paranum">19</div>
<div class="Normal"><SPAN STYLE="font-size: 80%">{<I>notwithstanding</I>}</SPAN> 
<A NAME="I7139"></A>Notwithstanding what this subclause says elsewhere, 
the Attach_Handler and Interrupt_Handler pragmas are allowed to be used 
for other, implementation defined, forms of interrupt handlers.&nbsp;</div>
<div class="paranum">19.a</div>
<div class="Annotations"><B>Ramification:&nbsp;</B>For example, if an implementation 
wishes to allow interrupt handlers to have parameters, it is allowed 
to do so via these pragmas; it need not invent implementation-defined 
pragmas for the purpose.&nbsp;</div>
<div class="paranum">19.b/2</div>
<div class="Annotations"><B>Implementation defined:&nbsp;</B>Any other forms 
of interrupt handler supported by the Attach_Handler and Interrupt_Handler 
pragmas.</div>

<H4 Class="centered">Implementation Advice</H4>
<div class="paranum">20</div>
<div class="Normal">Whenever possible, the implementation should allow 
interrupt handlers to be called directly by the hardware.&nbsp;</div>
<div class="paranum">20.a/2</div>
<div class="Annotations"><B>Implementation Advice:&nbsp;</B>Interrupt handlers 
should be called directly by the hardware.</div>
<div class="paranum">21</div>
<div class="Normal">Whenever practical, the implementation should detect 
violations of any implementation-defined restrictions before run time. 
</div>
<div class="paranum">21.a/2</div>
<div class="Annotations"><B>Implementation Advice:&nbsp;</B>Violations of 
any implementation-defined restrictions on interrupt handlers should 
be detected before run time.</div>
<div class="NotesHeader">NOTES</div>
<div class="paranum">22</div>
<div class="Notes">4&nbsp;&nbsp;The Attach_Handler pragma can provide 
static attachment of handlers to interrupts if the implementation supports 
preelaboration of protected objects. (See <A HREF="AA-C-4.html">C.4</A>.)</div>
<div class="paranum">23/2</div>
<div class="Notes">5&nbsp;&nbsp;{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00434.TXT">AI95-00434-01</A></I>} 
A protected object that has a (protected) procedure attached to an interrupt 
should have a ceiling priority at least as high as the highest processor 
priority at which that interrupt will ever be delivered.</div>
<div class="paranum">24</div>
<div class="Notes">6&nbsp;&nbsp;Protected procedures can also be attached 
dynamically to interrupts via operations declared in the predefined package 
Interrupts.</div>
<div class="paranum">25</div>
<div class="Notes">7&nbsp;&nbsp;An example of a possible implementation-defined 
restriction is disallowing the use of the standard storage pools within 
the body of a protected procedure that is an interrupt handler.</div>

<H4 Class="centered">Incompatibilities With Ada 95</H4>
<div class="paranum">25.a/2</div>
<div class="Annotations">{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00253.TXT">AI95-00253-01</A></I>} 
{<I>incompatibilities with Ada 95</I>} <A NAME="I7140"></A><B>Amendment 
Correction:</B> Corrected the wording so that the rules for the use of 
Attach_Handler and Interrupt_Handler are identical. This means that uses 
of pragma Interrupt_Handler outside of the target protected type or single 
protected object are now illegal.&nbsp;</div>

<H4 Class="centered">Wording Changes from Ada 95</H4>
<div class="paranum">25.b/2</div>
<div class="Annotations">{<I><A HREF="defect1.html#8652/0068">8652/0068</A></I>} 
{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00121.TXT">AI95-00121-01</A></I>} 
<B>Corrigendum:</B> Clarified the meaning of &ldquo;the previous handler&rdquo; 
when finalizing protected objects containing interrupt handlers.</div>
<div class="paranum">25.c/2</div>
<div class="Annotations">{<I><A HREF="http://www.ada-auth.org/cgi-bin/cvsweb.cgi/AIs/AI-00303.TXT">AI95-00303-01</A></I>} 
Dropped the requirement that an object of a type containing an Interrupt_Handler 
pragma must be declared at the library level. This was a generic contract 
model violation. This change is not an extension, as an attempt to attach 
such a handler with a routine in package Interrupts will fail an accessibility 
check anyway. Moreover, implementations can retain the rule as an implementation-defined 
restriction on the use of the type, as permitted by the Implementation 
Permissions above.&nbsp;</div>

<HR>
<div style="margin-top: 0.0em; margin-bottom: 0.6em"><A HREF="AA-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-0-5.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-C-3.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="AA-C-3-2.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</div>
<DIV Style="margin-top:0.0em"><IMG SRC="AE_logo.gif" height=100 width=113 align=right ALT="Ada-Europe">
<SPAN Style="font-size: 125%">Sponsored by <SPAN Style="font-size: 125%"><A HREF="http://www.ada-europe.org/"><B>Ada-Europe</B></A></SPAN></SPAN></DIV>
</BODY>
</HTML>
