<!-- Creator     : groff version 1.21 -->
<!-- CreationDate: Sat May  5 10:27:35 2012 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>ns_adp</title>

</head>
<body>

<h1 align="center">ns_adp</h1>

<a href="#NAME">NAME</a><br>
<a href="#DESCRIPTION">DESCRIPTION</a><br>
<a href="#CONFIGURATION">CONFIGURATION</a><br>
<a href="#ERROR HANDLING AND EXCEPTIONS">ERROR HANDLING AND EXCEPTIONS</a><br>
<a href="#SCRIPT BLOCK SCOPE">SCRIPT BLOCK SCOPE</a><br>
<a href="#BUFFER MANAGEMENT">BUFFER MANAGEMENT</a><br>
<a href="#CHARACTER ENCODING">CHARACTER ENCODING</a><br>
<a href="#SEE ALSO">SEE ALSO</a><br>
<a href="#KEYWORDS">KEYWORDS</a><br>

<hr>



<p style="margin-top: 1em">______________________________________________________________________________</p>

<h2>NAME
<a name="NAME"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">ns_adp &minus;
ADP introduction and operation</p>

<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Several
commands, normally beginning with the <b>ns_adp</b> prefix,
are used to support <b>AOLserver Dynamic Pages</b>, or
<b>ADP&rsquo;s</b>. ADP&rsquo;s are a server-side
environment for embedding Tcl code within static text blocks
(typically HTML or XML). The Tcl code is normally delimited
within <i>&lt;%</i> and <i>%&gt;</i> or <i>&lt;%=</i> and
<i>%&gt;</i> tags and can be used to generate additional
text or for any other purpose, e.g., updating a database.
The <i>&lt;% ...script... %&gt;</i> is used for cases where
the result of the Tcl script is ignored while the <i>&lt;%=
...script %&gt;</i> syntax is used to append the script
result to the output buffer. In either case, the
<b>ns_adp_puts</b> command can be used to add content to the
output buffer. A simple ADP file could contain:</p>

<p style="margin-left:22%; margin-top: 1em">&lt;html&gt;
<br>
&lt;head&gt;&lt;title&gt;Hello from &lt;%=[ns_info
hostname]%&gt;&lt;/title&gt;&lt;/head&gt; <br>
&lt;body&gt; <br>
Time is: &lt;%=[clock format [clock seconds]]%&gt; <br>
Four links: <br>
&lt;% <br>
for {set i 0} {$i &lt; 4} {incr i} {</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="3%"></td>
<td width="5%"></td>
<td width="92%">


<p>ns_adp_puts &quot;&lt;a href=/link/$i.htm&gt;Link
$i&lt;/a&gt;&lt;br&gt;&quot;</p> </td></tr>
</table>

<p style="margin-left:22%;">} <br>
%&gt; <br>
&lt;/body&gt;&lt;/html&gt;</p>

<p style="margin-left:11%; margin-top: 1em">Accessing this
page would generate output similar to:</p>

<p style="margin-left:22%; margin-top: 1em">&lt;html&gt;
<br>
&lt;head&gt;&lt;title&gt;Hello from
jgdavidson.local&lt;/title&gt;&lt;/head&gt; <br>
&lt;body&gt; <br>
Time is: Mon Aug 01 22:15:18 EDT 2005 <br>
Ten links: <br>
&lt;a href=/link/0.htm&gt;Link 0&lt;/a&gt;&lt;br&gt; <br>
&lt;a href=/link/1.htm&gt;Link 1&lt;/a&gt;&lt;br&gt; <br>
&lt;a href=/link/2.htm&gt;Link 2&lt;/a&gt;&lt;br&gt; <br>
&lt;a href=/link/3.htm&gt;Link 3&lt;/a&gt;&lt;br&gt; <br>
&lt;/body&gt;&lt;/html&gt;</p>

<p style="margin-left:11%; margin-top: 1em">ADP processing
normally occurs in the context of an HTTP transaction when
an URL request is mapped to an ADP file in the
server&rsquo;s page root. (see <b>ADP CONFIGURATION</b>
below for details on configuring this mapping). The ADP
request processing code allocates a Tcl interpreter and
includes the cooresponding ADP file. Output generated during
execution of the ADP is sent as a normal HTTP response,
using default status code of &quot;200 OK&quot; and the mime
type which corresponds to the ADP file extensions, normally
.adp and text/html (commands such as <b>ns_adp_mimetype</b>
can be used to control the eventual response type).</p>

<p style="margin-left:11%; margin-top: 1em">An ADP can
include additional ADP files with the <b>ns_adp_include</b>
command or evaluate ADP text/script code directly with
<b>ns_adp_eval</b>. This capability enables are large degree
of reuse of presentation and code between applications. Each
such included file or ADP string evaluation is performed in
it&rsquo;s own <i>call frame</i> similar to a Tcl procedure
with a local variable namespace. Arguments can be passed to
new call frames and then accessed with commands such as
<b>ns_adp_argv</b>. When necessary, commands such as
<b>ns_adp_abort</b> provide limited support to interrupt
and/or return from within an ADP, unwinding the ADP call
stack to the underyling C-level request processing code.</p>

<h2>CONFIGURATION
<a name="CONFIGURATION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">AOLserver can
be configured to execute ADP&rsquo;s placed with other
static files within a virtual server&rsquo;s pages directory
via the <i>map</i> parameter in the <i>adp</i> server config
section, for example:</p>

<p style="margin-left:22%; margin-top: 1em">ns_section
ns/server/server1/adp <br>
ns_param map /*.adp <br>
ns_param map {/stories/*.adp 60}</p>

<p style="margin-left:11%; margin-top: 1em">The first map
will evaluate all files which end in <i>.adp</i> and do not
have more specific mappings (such as the second map). The
second config map will execute files which end with
<i>.adp</i> located under the <i>/stories</i> directly and
also specifies a cache timeout in seconds. In this case,
results will be retained and returned to subsequent requests
without re-executing the ADP for up to 60 seconds (see the
<i>-cache</i> paramter to the <b>ns_adp_include</b> command
for more details).</p>

<p style="margin-left:11%; margin-top: 1em">Alternatively,
arbitrary URL&rsquo;s may be mapped to individual ADP files
using the <b>ns_register_adp</b> command. This command would
normally be included in a virtual-server initialization
scripts within the <i>modules/tcl/</i> server
subdirectory.</p>

<h2>ERROR HANDLING AND EXCEPTIONS
<a name="ERROR HANDLING AND EXCEPTIONS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">By default,
errors within an ADP script block are reported in the server
log and interrupt execution of the current block only;
subsequent text and script blocks continue to be processed
and and no error message is included in the output. This
approach is highly defensive and has the benefit of
generating a valid, if partial, responses after minor
errors. A negative aspect of this approach is that, without
careful monitoring of the server log, such errors can easily
be ignored.</p>

<p style="margin-left:11%; margin-top: 1em">The default
error handling behavior can be modified by settings one or
more virtual-server configuration flags:</p>

<p style="margin-left:22%; margin-top: 1em">ns_section
ns/server/server1/adp <br>
ns_param stricterror false; # Interrupt execution on any
error. <br>
ns_param displayerror false; # Include error message in
output. <br>
ns_param detailerror true; # Include connection details
messages.</p>

<p style="margin-left:11%; margin-top: 1em">These flags,
along with other options, can be queried or modified for an
individual ADP execution stream via the
<b>ns_adp_ctl</b>.</p>

<h2>SCRIPT BLOCK SCOPE
<a name="SCRIPT BLOCK SCOPE"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">By default,
each Tcl block is independent of other blocks and must be a
complete script. In particular, this means that conditional
code cannot span blocks, e.g., the following does not work
by default:</p>

<p style="margin-left:22%; margin-top: 1em">&lt;% foreach
elem $list { %&gt;</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="3%"></td>
<td width="97%">


<p>Here is an &lt;%=$elem%&gt; element.</p></td></tr>
</table>

<p style="margin-left:22%;">&lt;% } %&gt;</p>

<p style="margin-left:11%; margin-top: 1em">This behavior
can be changed with the <i>singlescript</i> config option or
via the <b>ns_adp_ctl</b> command which instructs the ADP
parser to converts all text/code blocks within an ADP into a
single Tcl script block:</p>

<p style="margin-left:22%; margin-top: 1em">ns_section
ns/server/server1/adp <br>
ns_param singlescript false; # Combine code blocks into one
scripts.</p>

<p style="margin-left:11%; margin-top: 1em">Setting this
option would covert the script above into the following
equivalent:</p>

<p style="margin-left:22%; margin-top: 1em">&lt;% foreach
elem $list {</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="3%"></td>
<td width="97%">


<p>ns_adp_puts -nonewline &quot;\n Here is an &quot;</p></td></tr>
<tr valign="top" align="left">
<td width="3%"></td>
<td width="97%">


<p>ns_adp_puts -nonewline $elem</p></td></tr>
<tr valign="top" align="left">
<td width="3%"></td>
<td width="97%">


<p>ns_adp_puts -nonewline &quot; element.\n&quot;</p></td></tr>
</table>

<p style="margin-left:22%;">} %&gt;</p>

<p style="margin-left:11%; margin-top: 1em">Note that this
option combines scripts within a particular ADP file, it
does not combine scripts which span multiple included
ADP&rsquo;s. In addition, error semantics described above
apply to the combined script and any error within any block
combined into a single script will stop execution of the
entire included page.</p>

<h2>BUFFER MANAGEMENT
<a name="BUFFER MANAGEMENT"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Output
including accumulated text blocks and output generated by
Tcl script blocks is normally buffered internally until the
end of the connection. Once complete, a single response is
generated which follows HTTP response headers indicating the
resulting content length. The content may optionally be gzip
compressed first.</p>

<p style="margin-left:11%; margin-top: 1em">Alternatively,
an incremental response can be be generated either in
response to calling the <b>ns_adp_stream</b> or
<b>ns_adp_flush</b> commands or automatically due to buffer
overflow. In this case, an HTTP response will be generated
on the first flush which specifies incremental content using
HTTP/1.1 chunked-encoding. Forcing a connection into
streaming mode can be useful for certain long running
requests where it&rsquo;s reasonable to expect the browser
can render incremental respnoses.</p>

<p style="margin-left:11%; margin-top: 1em">The size of the
internal buffer and gzip compression options can be set with
corresponding server and ADP config options. Note both the
virtual-server wide gzip and ADP gzip options must be
enabled to support compression of ADP output.</p>

<p style="margin-left:22%; margin-top: 1em">ns_section
ns/server/server1 <br>
ns_param gzip true; # Enable compression. <br>
ns_param gziplevel 4; # Compression level. <br>
ns_param gzipmin 4096; # Minimum size before gzip.</p>

<p style="margin-left:22%; margin-top: 1em">ns_section
ns/server/server1/adp <br>
ns_param gzip true; # Enable ADP output compression. <br>
ns_param bufsize 102400; # Buffer size, 1meg default.</p>

<h2>CHARACTER ENCODING
<a name="CHARACTER ENCODING"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The ADP
interface uses the server&rsquo;s mimetype configuration to
map file extensions to charsets and cooresponding encoding.
This configuration is necessary to ensure the file text and
script blocks are properly coverted to UTF-8 for use
internally. This mimetype is also used to set the character
output encoding although the <b>ns_conn encoding</b> option
can be used to override the encoding if necessary.</p>

<h2>SEE ALSO
<a name="SEE ALSO"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em">ns_adp_include(n),
ns_adp_puts(n), ns_adp_ctl(n)</p>

<h2>KEYWORDS
<a name="KEYWORDS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">ADP, dynamic
pages</p>
<hr>
</body>
</html>
